"""
ä¸ªæ€§åŒ–ç ´è§£æ–¹æ¡ˆç”Ÿæˆå™¨
Personalized Solution Generator

åŠŸèƒ½ï¼š
1. åŸºäºç”¨æˆ·ç‹¬ç‰¹çš„å‘½ç†ç»“æ„ï¼Œæä¾›ä¸ªæ€§åŒ–çš„é—®é¢˜ç ´è§£æ€è·¯
2. è¯†åˆ«ç”¨æˆ·çš„ä¼˜åŠ¿èƒ½é‡æ¨¡å¼å¹¶è½¬åŒ–ä¸ºå…·ä½“èƒ½åŠ›
3. æ¸©å’Œåœ°æŒ‡å‡ºå¯èƒ½çš„ç›²ç‚¹å’ŒæŒ‘æˆ˜
4. æä¾›åŸºäºä¸ªäººç‰¹è´¨çš„å¯æ‰§è¡Œè¡ŒåŠ¨å»ºè®®
5. å°†ç—…è¯åˆ†æè½¬åŒ–ä¸ºæ„è¯†å±‚é¢çš„æŒ‡å¯¼
"""

from typing import Dict, Any, List, Optional
from dataclasses import dataclass

@dataclass
class PersonalizedSolution:
    """ä¸ªæ€§åŒ–è§£å†³æ–¹æ¡ˆ"""
    strength_patterns: List[str]    # ä¼˜åŠ¿æ¨¡å¼
    blind_spots: List[str]         # ç›²ç‚¹æé†’
    actionable_steps: List[str]    # å¯æ‰§è¡Œæ­¥éª¤
    medicine_guidance: Dict[str, str] # ç”¨è¯æŒ‡å¯¼
    timing_advice: str             # æ—¶æœºå»ºè®®
    energy_management: str         # èƒ½é‡ç®¡ç†

class PersonalizedSolutionGenerator:
    """ä¸ªæ€§åŒ–æ–¹æ¡ˆç”Ÿæˆå™¨"""
    
    def __init__(self):
        # ä¼˜åŠ¿æ¨¡å¼æ˜ å°„è¡¨
        self.strength_patterns = {
            "æ¯”è‚©æ—º": {
                "core_strengths": [
                    "å¤©ç”Ÿçš„é¢†å¯¼åŠ›å’Œç‹¬ç«‹æ€è€ƒèƒ½åŠ›",
                    "åœ¨å›°éš¾æ—¶æœŸèƒ½å¤ŸåšæŒä¸æ‡ˆçš„éŸ§æ€§",
                    "ä¸è¢«å¤–ç•Œå£°éŸ³è½»æ˜“å½±å“çš„å†…åœ¨å®šåŠ›",
                    "èƒ½å¤Ÿæ‰¿æ‹…è´£ä»»å’Œç‹¬è‡ªé¢å¯¹æŒ‘æˆ˜çš„å‹‡æ°”"
                ],
                "practical_applications": [
                    "åœ¨å›¢é˜Ÿä¸­ï¼Œæ‚¨å¾€å¾€èƒ½æå‡ºç‹¬ç‰¹è€Œæœ‰ä»·å€¼çš„è§‚ç‚¹",
                    "åœ¨å†³ç­–æ—¶ï¼Œæ‚¨çš„ç›´è§‰å¾€å¾€æ¯”åˆ†ææ›´å‡†ç¡®",
                    "åœ¨å‹åŠ›ä¸‹ï¼Œæ‚¨åè€Œèƒ½å‘æŒ¥å‡ºæ›´å¥½çš„çŠ¶æ€",
                    "åœ¨éœ€è¦çªç ´çš„æ—¶å€™ï¼Œæ‚¨æœ‰æ•¢äºç¬¬ä¸€ä¸ªå°è¯•çš„é­„åŠ›"
                ]
            },
            "å°é‡": {
                "core_strengths": [
                    "å¼ºå¤§çš„å­¦ä¹ èƒ½åŠ›å’ŒçŸ¥è¯†å¸æ”¶èƒ½åŠ›",
                    "æ·±åº¦æ€è€ƒå’Œç³»ç»Ÿæ€§åˆ†æçš„å¤©èµ‹",
                    "è·å¾—ä»–äººä¿¡ä»»å’Œä¾èµ–çš„äº²å’ŒåŠ›",
                    "åœ¨å¤æ‚æƒ…å†µä¸‹ä¿æŒå†·é™åˆ¤æ–­çš„èƒ½åŠ›"
                ],
                "practical_applications": [
                    "æ‚¨å¾ˆå–„äºä»å¤±è´¥ä¸­å¸å–æ•™è®­",
                    "æ‚¨èƒ½çœ‹åˆ°åˆ«äººçœ‹ä¸åˆ°çš„æ·±å±‚æ¬¡é—®é¢˜",
                    "æ‚¨åœ¨éœ€è¦è€å¿ƒå’ŒåšæŒçš„ä»»åŠ¡ä¸Šè¡¨ç°ä¼˜å¼‚",
                    "æ‚¨èƒ½å¤Ÿåœ¨æ··ä¹±ä¸­å»ºç«‹ç§©åºå’Œä½“ç³»"
                ]
            },
            "è´¢æ—º": {
                "core_strengths": [
                    "å¼ºçƒˆçš„ç›®æ ‡å¯¼å‘å’Œç»“æœæ„è¯†",
                    "å–„äºå‘ç°æœºä¼šå’ŒæŠŠæ¡æ—¶æœºçš„æ•é”åº¦",
                    "å°†æƒ³æ³•è½¬åŒ–ä¸ºç°å®çš„æ‰§è¡ŒåŠ›",
                    "åœ¨èµ„æºé…ç½®å’Œä»·å€¼åˆ›é€ ä¸Šçš„å¤©èµ‹"
                ],
                "practical_applications": [
                    "æ‚¨å¾ˆå–„äºåˆ¶å®šå®é™…å¯è¡Œçš„è®¡åˆ’",
                    "æ‚¨èƒ½åœ¨å¤æ‚çš„é€‰æ‹©ä¸­æ‰¾åˆ°æœ€æœ‰ä»·å€¼çš„æ–¹å‘",
                    "æ‚¨çŸ¥é“å¦‚ä½•ç”¨æœ€å°çš„æŠ•å…¥è·å¾—æœ€å¤§çš„å›æŠ¥",
                    "æ‚¨åœ¨å•†ä¸šå’ŒæŠ•èµ„æ–¹é¢æœ‰å¤©ç„¶çš„å—…è§‰"
                ]
            },
            "ç…é‡": {
                "core_strengths": [
                    "å¼ºå¤§çš„è´£ä»»å¿ƒå’Œä½¿å‘½æ„Ÿ",
                    "åœ¨å‹åŠ›ä¸‹åè€Œèƒ½å‘æŒ¥æ›´å¥½çš„èƒ½åŠ›",
                    "å¯¹è§„åˆ™å’Œæ ‡å‡†çš„æ·±åº¦ç†è§£",
                    "èƒ½å¤Ÿæ‰¿æ‹…ä»–äººä¸æ„¿æ‰¿æ‹…çš„é‡ä»»"
                ],
                "practical_applications": [
                    "æ‚¨åœ¨éœ€è¦ä¸¥è°¨å’Œç²¾ç¡®çš„å·¥ä½œä¸­è¡¨ç°å“è¶Š",
                    "æ‚¨èƒ½å¤Ÿåœ¨å±æœºæ—¶åˆ»ä¿æŒå†·é™å’Œç†æ€§",
                    "æ‚¨çš„æ‰¿è¯ºå’Œä¿è¯å¾€å¾€æ¯”åˆåŒæ›´æœ‰æ•ˆåŠ›",
                    "æ‚¨èƒ½å¤Ÿå»ºç«‹å’Œç»´æŠ¤é«˜æ•ˆçš„è§„åˆ™ä½“ç³»"
                ]
            },
            "ä¼¤å®˜æ—º": {
                "core_strengths": [
                    "ä¸°å¯Œçš„åˆ›é€ åŠ›å’Œç‹¬ç‰¹çš„è¡¨è¾¾æ–¹å¼",
                    "æ•é”çš„ç›´è§‰å’Œæƒ…æ„Ÿæ„ŸçŸ¥èƒ½åŠ›",
                    "ä¸è¢«ä¼ ç»Ÿæ€ç»´æŸç¼šçš„åˆ›æ–°ç²¾ç¥",
                    "èƒ½å¤Ÿæ„ŸæŸ“å’Œå¯å‘ä»–äººçš„ä¸ªäººé­…åŠ›"
                ],
                "practical_applications": [
                    "æ‚¨åœ¨éœ€è¦åˆ›æ–°å’Œçªç ´çš„é¡¹ç›®ä¸­è¡¨ç°å‡ºè‰²",
                    "æ‚¨èƒ½å¤Ÿç”¨ç‹¬ç‰¹çš„æ–¹å¼è§£å†³å¸¸è§„æ–¹æ³•è§£å†³ä¸äº†çš„é—®é¢˜",
                    "æ‚¨çš„æƒ³æ³•å¾€å¾€èƒ½ç»™å›¢é˜Ÿå¸¦æ¥æ–°çš„çµæ„Ÿ",
                    "æ‚¨åœ¨è‰ºæœ¯ã€è®¾è®¡ã€åˆ›æ„ç±»å·¥ä½œä¸­æœ‰å¤©ç„¶ä¼˜åŠ¿"
                ]
            }
        }
        
        # ç›²ç‚¹å’ŒæŒ‘æˆ˜æ˜ å°„
        self.blind_spots = {
            "æ¯”è‚©æ—º": [
                "æœ‰æ—¶å€™è¿‡äºåšæŒå·±è§ï¼Œå¯èƒ½ä¼šé”™è¿‡ä»–äººçš„å¥½å»ºè®®",
                "åœ¨éœ€è¦å¦¥åå’Œåè°ƒçš„æ—¶å€™å¯èƒ½æ˜¾å¾—è¿‡äºå¼ºç¡¬",
                "å¯èƒ½ä¼šå› ä¸ºå¤ªç‹¬ç«‹è€Œé”™è¿‡åˆä½œçš„æœºä¼š"
            ],
            "å°é‡": [
                "æœ‰æ—¶å€™æƒ³å¾—å¤ªå¤šï¼Œè¡ŒåŠ¨å¾—å¤ªå°‘",
                "å¯èƒ½ä¼šè¿‡åˆ†ä¾èµ–å¤–ç•Œçš„è®¤å¯å’Œæ”¯æŒ",
                "åœ¨éœ€è¦å¿«é€Ÿå†³ç­–çš„æ—¶å€™å¯èƒ½ä¼šçŠ¹è±«ä¸å†³"
            ],
            "è´¢æ—º": [
                "å¯èƒ½ä¼šè¿‡åˆ†å…³æ³¨çŸ­æœŸæ”¶ç›Šè€Œå¿½ç•¥é•¿æœŸä»·å€¼",
                "æœ‰æ—¶å€™ä¼šä¸ºäº†ç›®æ ‡è€Œå¿½ç•¥è¿‡ç¨‹ä¸­çš„æ„Ÿå—",
                "å¯èƒ½ä¼šåœ¨äººé™…å…³ç³»ä¸­æ˜¾å¾—å¤ªåŠŸåˆ©"
            ],
            "ç…é‡": [
                "æœ‰æ—¶å€™å¯¹è‡ªå·±å’Œä»–äººçš„è¦æ±‚è¿‡äºä¸¥æ ¼",
                "å¯èƒ½ä¼šå› ä¸ºå¤ªæ³¨é‡è§„åˆ™è€Œç¼ºä¹çµæ´»æ€§",
                "åœ¨è½»æ¾çš„ç¯å¢ƒä¸­å¯èƒ½åè€Œä¸çŸ¥é“æ€ä¹ˆæ”¾æ¾"
            ],
            "ä¼¤å®˜æ—º": [
                "æœ‰æ—¶å€™å¤ªè¿‡è¿½æ±‚åˆ›æ–°è€Œå¿½ç•¥äº†ç°å®çš„é™åˆ¶",
                "å¯èƒ½ä¼šå› ä¸ºå¤ªä¸ªæ€§åŒ–è€Œéš¾ä»¥ä¸ä»–äººé…åˆ",
                "åœ¨éœ€è¦éµå®ˆè§„åˆ™çš„ç¯å¢ƒä¸­å¯èƒ½ä¼šæ„Ÿåˆ°å‹æŠ‘"
            ]
        }
        
        # ç”¨è¯æŒ‡å¯¼ï¼ˆå°†ç—…è¯ç†è®ºè½¬åŒ–ä¸ºæ„è¯†å±‚é¢çš„æŒ‡å¯¼ï¼‰
        self.medicine_guidance = {
            "å›è¯": {
                "æ¯”è‚©": {
                    "positive": "åŸ¹å…»åº•æ°”å’Œæ‰¿è½½åŠ›ï¼Œç›¸ä¿¡è‡ªå·±æœ‰èƒ½åŠ›å¤„ç†å„ç§æŒ‘æˆ˜",
                    "practice": "æ¯å¤©ç»™è‡ªå·±ä¸€äº›ç‹¬ç«‹å†³ç­–çš„æœºä¼šï¼Œä»å°äº‹å¼€å§‹å»ºç«‹è‡ªä¿¡"
                },
                "å°": {
                    "positive": "å‘æŒ¥å­¦ä¹ èƒ½åŠ›å’Œæ™ºæ…§ç§¯ç´¯ï¼Œæˆä¸ºå€¼å¾—ä¾èµ–çš„ä¸“å®¶",
                    "practice": "æŒç»­å­¦ä¹ ï¼ŒåŒæ—¶ä¹Ÿè¦æ•¢äºåˆ†äº«æ‚¨çš„çŸ¥è¯†å’Œè§è§£"
                },
                "è´¢": {
                    "positive": "å‘æŒ¥ç›®æ ‡å¯¼å‘å’Œæ‰§è¡ŒåŠ›ï¼Œåˆ›é€ å®é™…ä»·å€¼",
                    "practice": "è®¾å®šå…·ä½“å¯è¾¾æˆçš„ç›®æ ‡ï¼Œå¹¶åˆ¶å®šè¯¦ç»†çš„è¡ŒåŠ¨è®¡åˆ’"
                },
                "ç…": {
                    "positive": "å‘æŒ¥è´£ä»»å¿ƒå’Œæ‰¿å‹èƒ½åŠ›ï¼Œæˆä¸ºå›¢é˜Ÿçš„å®šæµ·ç¥é’ˆ",
                    "practice": "ä¸»åŠ¨æ‰¿æ‹…æœ‰æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ï¼Œåœ¨å®Œæˆä¸­å»ºç«‹å¨ä¿¡"
                },
                "ä¼¤å®˜": {
                    "positive": "å‘æŒ¥åˆ›é€ åŠ›å’Œè¡¨è¾¾èƒ½åŠ›ï¼Œä¸ºä¸–ç•Œå¸¦æ¥æ–°çš„å¯èƒ½",
                    "practice": "æ‰¾åˆ°é€‚åˆçš„åˆ›æ„è¡¨è¾¾æ¸ é“ï¼Œè®©æ‚¨çš„æƒ³æ³•èƒ½å¤Ÿå½±å“ä»–äºº"
                }
            }
        }
    
    def generate_solution(self, bazi_analysis: Dict[str, Any], question_analysis: Any, 
                         bingyao_analysis: Dict[str, Any]) -> PersonalizedSolution:
        """ç”Ÿæˆä¸ªæ€§åŒ–è§£å†³æ–¹æ¡ˆ"""
        
        # è·å–ä¸»è¦æ ¼å±€ç±»å‹
        geju_info = bazi_analysis.get("å®šæ ¼å±€", {})
        geju_type = geju_info.get("æ ¼å±€ç±»å‹", "å¹³è¡¡æ ¼å±€")
        
        # è·å–ç—…è¯é…ç½®
        bingyao_config = bingyao_analysis.get("ç—…è¯é…ç½®", {})
        jun_yao = bingyao_config.get("å›è¯", "")
        chen_yao = bingyao_config.get("è‡£è¯", "")
        ci_yao = bingyao_config.get("æ¬¡è¯", "")
        
        # è·å–å¤§è¿ä¿¡æ¯
        dayun_info = bazi_analysis.get("çœ‹å¤§è¿", {})
        current_dayun = dayun_info.get("å½“å‰å¤§è¿", {})
        
        # 1. è¯†åˆ«ä¼˜åŠ¿æ¨¡å¼
        strength_patterns = self._identify_strength_patterns(geju_type, bazi_analysis)
        
        # 2. æŒ‡å‡ºç›²ç‚¹ï¼ˆæ¸©å’Œæ–¹å¼ï¼‰
        blind_spots = self._identify_blind_spots(geju_type)
        
        # 3. ç”Ÿæˆå¯æ‰§è¡Œæ­¥éª¤
        actionable_steps = self._generate_actionable_steps(question_analysis, geju_type, bingyao_config)
        
        # 4. ç”¨è¯æŒ‡å¯¼
        medicine_guidance = self._generate_medicine_guidance(jun_yao, chen_yao, ci_yao)
        
        # 5. æ—¶æœºå»ºè®®
        timing_advice = self._generate_timing_advice(current_dayun, geju_type)
        
        # 6. èƒ½é‡ç®¡ç†
        energy_management = self._generate_energy_management(bazi_analysis)
        
        return PersonalizedSolution(
            strength_patterns=strength_patterns,
            blind_spots=blind_spots,
            actionable_steps=actionable_steps,
            medicine_guidance=medicine_guidance,
            timing_advice=timing_advice,
            energy_management=energy_management
        )
    
    def _identify_strength_patterns(self, geju_type: str, bazi_analysis: Dict[str, Any]) -> List[str]:
        """è¯†åˆ«ä¼˜åŠ¿æ¨¡å¼"""
        base_strengths = self.strength_patterns.get(geju_type, {}).get("core_strengths", [])
        practical_apps = self.strength_patterns.get(geju_type, {}).get("practical_applications", [])
        
        # ç»“åˆå…·ä½“çš„äº”è¡Œåˆ†å¸ƒè¿›è¡Œä¸ªæ€§åŒ–
        wuxing_stats = bazi_analysis.get("äº”è¡Œç»Ÿè®¡", {})
        strongest_element = wuxing_stats.get("æœ€æ—º", "")
        
        personalized_strengths = []
        personalized_strengths.extend(base_strengths[:2])  # å–å‰ä¸¤ä¸ªæ ¸å¿ƒä¼˜åŠ¿
        personalized_strengths.extend(practical_apps[:2])  # å–å‰ä¸¤ä¸ªå®é™…åº”ç”¨
        
        return personalized_strengths
    
    def _identify_blind_spots(self, geju_type: str) -> List[str]:
        """è¯†åˆ«ç›²ç‚¹ï¼ˆæ¸©å’Œæé†’ï¼‰"""
        base_spots = self.blind_spots.get(geju_type, [])
        
        # è½¬æ¢ä¸ºæ¸©å’Œçš„æé†’è¯­è¨€
        gentle_reminders = []
        for spot in base_spots:
            gentle_version = spot.replace("å¯èƒ½ä¼š", "æœ‰æ—¶å€™").replace("è¿‡äº", "ç¨å¾®")
            gentle_reminders.append(f"æ¸©é¦¨æé†’ï¼š{gentle_version}ï¼Œè¿™ä¹Ÿæ˜¯æ‚¨å¯ä»¥ç»§ç»­ä¼˜åŒ–çš„åœ°æ–¹ã€‚")
        
        return gentle_reminders[:2]  # æœ€å¤šä¸¤ä¸ªæé†’
    
    def _generate_actionable_steps(self, question_analysis: Any, geju_type: str, bingyao_config: Dict[str, str]) -> List[str]:
        """ç”Ÿæˆå¯æ‰§è¡Œçš„è¡ŒåŠ¨æ­¥éª¤"""
        category = getattr(question_analysis, 'question_category', 'general')
        
        # åŸºäºé—®é¢˜ç±»å‹å’Œå‘½å±€ç±»å‹ç”Ÿæˆå…·ä½“æ­¥éª¤
        action_templates = {
            ("career_entrepreneurship", "æ¯”è‚©æ—º"): [
                "ç¬¬ä¸€æ­¥ï¼šåˆ—å‡ºæ‚¨æœ€æ“…é•¿å’Œæœ€æ„Ÿå…´è¶£çš„3ä¸ªé¢†åŸŸ",
                "ç¬¬äºŒæ­¥ï¼šåœ¨æ¯ä¸ªé¢†åŸŸä¸­æ‰¾åˆ°1-2ä¸ªå…·ä½“çš„æœºä¼šç‚¹",
                "ç¬¬ä¸‰æ­¥ï¼šä»æœ€å°é£é™©çš„æœºä¼šå¼€å§‹å°è¯•ï¼Œç§¯ç´¯ç»éªŒ",
                "ç¬¬å››æ­¥ï¼šæ ¹æ®å®é™…æ•ˆæœè°ƒæ•´æ–¹å‘ï¼Œä¿æŒè¡ŒåŠ¨çš„æŒç»­æ€§"
            ],
            ("career_entrepreneurship", "å°é‡"): [
                "ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°ä¸€ä¸ªæ‚¨å°Šæ•¬çš„å¯¼å¸ˆæˆ–æˆåŠŸæ¦œæ ·",
                "ç¬¬äºŒæ­¥ï¼šç³»ç»Ÿå­¦ä¹ ç›¸å…³çš„çŸ¥è¯†å’ŒæŠ€èƒ½",
                "ç¬¬ä¸‰æ­¥ï¼šä»å°é¡¹ç›®å¼€å§‹å®è·µï¼Œç§¯ç´¯å®æˆ˜ç»éªŒ",
                "ç¬¬å››æ­¥ï¼šåœ¨ç¡®è®¤å¯è¡Œæ€§åå†æ‰©å¤§è§„æ¨¡"
            ],
            ("relationships_marriage", "æ¯”è‚©æ—º"): [
                "ç¬¬ä¸€æ­¥ï¼šæ˜ç¡®æ‚¨åœ¨å…³ç³»ä¸­çš„åº•çº¿å’ŒåŸåˆ™",
                "ç¬¬äºŒæ­¥ï¼šå­¦ä¼šåœ¨åšæŒè‡ªæˆ‘çš„åŒæ—¶ç»™å¯¹æ–¹ç©ºé—´",
                "ç¬¬ä¸‰æ­¥ï¼šæ‰¾åˆ°å…±åŒçš„ç›®æ ‡å’Œä»·å€¼è§‚",
                "ç¬¬å››æ­¥ï¼šåœ¨å†²çªä¸­å­¦ä¼šç†æ€§æ²Ÿé€šè€Œä¸æ˜¯æƒ…ç»ªå¯¹æŠ—"
            ]
        }
        
        key = (category, geju_type)
        specific_steps = action_templates.get(key)
        
        if specific_steps:
            return specific_steps
        
        # é€šç”¨è¡ŒåŠ¨æ­¥éª¤æ¨¡æ¿
        return [
            "ç¬¬ä¸€æ­¥ï¼šæ˜ç¡®æ‚¨çœŸæ­£æƒ³è¦çš„æ˜¯ä»€ä¹ˆ",
            "ç¬¬äºŒæ­¥ï¼šè¯„ä¼°ç°æœ‰çš„èµ„æºå’Œèƒ½åŠ›",
            "ç¬¬ä¸‰æ­¥ï¼šåˆ¶å®šæ¸è¿›å¼çš„è¡ŒåŠ¨è®¡åˆ’",
            "ç¬¬å››æ­¥ï¼šåœ¨è¡ŒåŠ¨ä¸­ä¸æ–­è°ƒæ•´å’Œä¼˜åŒ–"
        ]
    
    def _generate_medicine_guidance(self, jun_yao: str, chen_yao: str, ci_yao: str) -> Dict[str, str]:
        """ç”Ÿæˆç”¨è¯æŒ‡å¯¼ï¼ˆæ„è¯†å±‚é¢ï¼‰"""
        
        # åç¥çš„æ­£å‘æ„è¯†å“è´¨ï¼ˆä½œä¸ºè¯çš„æ—¶å€™ï¼‰
        positive_consciousness = {
            "æ¯”è‚©": "åº•æ°”ã€æ‰¿è½½åŠ›ã€è‡ªæˆ‘è‚¯å®šã€å†…åœ¨åŠ›é‡ã€åšå®šæ„å¿—",
            "åŠ«è´¢": "å›¢é˜Ÿç²¾ç¥ã€åä½œèƒ½åŠ›ã€åˆ†äº«æ„è¯†ã€é›†ä½“åˆ©ç›Š",
            "é£Ÿç¥": "ç†æ€§æ€è€ƒã€é•¿è¿œè§„åˆ’ã€ç³»ç»Ÿæ€ç»´ã€æ™ºæ…§åˆ†äº«",
            "ä¼¤å®˜": "åˆ›é€ åŠ›ã€è¡¨è¾¾èƒ½åŠ›ã€çªç ´ç²¾ç¥ã€ä¸ªæ€§é­…åŠ›",
            "æ­£è´¢": "ç›®æ ‡æ„è¯†ã€æ‰§è¡ŒåŠ›ã€æˆæœå¯¼å‘ã€ä»·å€¼åˆ›é€ ",
            "åè´¢": "æœºä¼šæ„è¯†ã€è¡ŒåŠ¨åŠ›ã€çµæ´»åº”å˜ã€å¿«é€Ÿå†³ç­–",
            "æ­£å®˜": "è´£ä»»å¿ƒã€è§„åˆ™æ„è¯†ã€ç¨³é‡å¯é ã€ç¤¾ä¼šè´£ä»»",
            "ä¸ƒæ€": "æ‰¿å‹èƒ½åŠ›ã€å†³æ–­åŠ›ã€å±æœºå¤„ç†ã€é¢†å¯¼å¨ä¸¥",
            "æ­£å°": "å­¦ä¹ èƒ½åŠ›ã€æ™ºæ…§ç§¯ç´¯ã€è´µäººè¿ã€ç¨³å®šå‘å±•",
            "åå°": "ç›´è§‰æ´å¯Ÿã€ç‹¬ç«‹æ€è€ƒã€å¦ç±»æ™ºæ…§ã€åˆ›æ–°æ€ç»´"
        }
        
        # åç¥çš„è´Ÿå‘è¡¨è¾¾ï¼ˆä½œä¸ºç—…çš„æ—¶å€™ï¼‰
        negative_consciousness = {
            "æ¯”è‚©": "è‡ªå¤§ã€åˆšæ„è‡ªç”¨ã€è¿‡åˆ†ç‹¬ç«‹ã€ä¸å–„åˆä½œ",
            "åŠ«è´¢": "äº‰å¼ºå¥½èƒœã€èµ„æºäº‰å¤ºã€è¿‡åˆ†ç«äº‰ã€æŸäººåˆ©å·±",
            "é£Ÿç¥": "è¿‡åˆ†æŒ‘å‰”ã€ç†æƒ³ä¸»ä¹‰ã€è„±ç¦»ç°å®ã€ç©ºè°ˆç†è®º",
            "ä¼¤å®˜": "å›é€†ä»»æ€§ã€æƒ…ç»ªåŒ–ã€ç ´åè§„åˆ™ã€è¿‡åˆ†ä¸ªæ€§",
            "æ­£è´¢": "è¿‡åˆ†åŠŸåˆ©ã€çŸ­è§†è¿‘åˆ©ã€å¿½ç•¥æ„Ÿæƒ…ã€ç‰©è´¨è‡³ä¸Š",
            "åè´¢": "æŠ•æœºå–å·§ã€ç¼ºä¹åšæŒã€è§å¼‚æ€è¿ã€æµ®èºä¸å®‰",
            "æ­£å®˜": "è¿‡åˆ†ä¿å®ˆã€ç¼ºä¹åˆ›æ–°ã€ä¾èµ–æƒå¨ã€å®³æ€•å˜åŒ–",
            "ä¸ƒæ€": "è¿‡åˆ†ä¸¥å‰ã€å‹æŠ‘è‡ªç”±ã€ç‹¬æ–­ä¸“è¡Œã€ç¼ºä¹æ¸©æƒ…",
            "æ­£å°": "è¿‡åˆ†ä¾èµ–ã€ç¼ºä¹è¡ŒåŠ¨ã€é€ƒé¿è´£ä»»ã€å®‰äºç°çŠ¶",
            "åå°": "å­¤åƒ»ç¦»ç¾¤ã€æ€ç»´åæ‰§ã€è¿‡åˆ†å¦ç±»ã€éš¾ä»¥ç†è§£"
        }
        
        guidance = {}
        
        if jun_yao:
            positive_traits = positive_consciousness.get(jun_yao, "ç§¯ææ­£å‘çš„å“è´¨")
            guidance["å›è¯æŒ‡å¯¼"] = f"é‡ç‚¹åŸ¹å…»{jun_yao}çš„æ­£å‘å“è´¨ï¼š{positive_traits}ã€‚è¿™æ˜¯æ‚¨æœ€éœ€è¦åŠ å¼ºçš„æ ¸å¿ƒèƒ½åŠ›ã€‚"
        
        if chen_yao:
            positive_traits = positive_consciousness.get(chen_yao, "è¾…åŠ©æ€§çš„å“è´¨")
            guidance["è‡£è¯æŒ‡å¯¼"] = f"åŒæ—¶å‘å±•{chen_yao}çš„ä¼˜åŠ¿ï¼š{positive_traits}ã€‚è¿™èƒ½ä¸ºæ‚¨çš„æ ¸å¿ƒèƒ½åŠ›æä¾›æœ‰åŠ›æ”¯æ’‘ã€‚"
        
        if ci_yao:
            positive_traits = positive_consciousness.get(ci_yao, "è¡¥å……æ€§çš„å“è´¨")
            guidance["æ¬¡è¯æŒ‡å¯¼"] = f"é€‚å½“åŸ¹å…»{ci_yao}çš„ç‰¹è´¨ï¼š{positive_traits}ã€‚è¿™èƒ½è®©æ‚¨çš„èƒ½åŠ›æ›´åŠ å…¨é¢ã€‚"
        
        return guidance
    
    def _generate_timing_advice(self, current_dayun: Dict[str, Any], geju_type: str) -> str:
        """ç”Ÿæˆæ—¶æœºå»ºè®®"""
        if not current_dayun:
            return "æŠŠæ¡å½“ä¸‹ï¼Œé¡ºå…¶è‡ªç„¶åœ°å‘å±•ã€‚"
        
        age_range = current_dayun.get("age_range", "")
        influence = current_dayun.get("influence", "")
        
        timing_templates = {
            "æ¯”è‚©æ—º": f"å½“å‰{age_range}å²çš„å¤§è¿é˜¶æ®µï¼Œ{influence}ã€‚è¿™æ˜¯æ‚¨å‘æŒ¥ç‹¬ç«‹èƒ½åŠ›çš„å¥½æ—¶æœºï¼Œå»ºè®®ä¸»åŠ¨å‡ºå‡»ï¼Œä¸è¦ç­‰å¾…ã€‚",
            "å°é‡": f"åœ¨{age_range}å²è¿™ä¸ªé˜¶æ®µï¼Œ{influence}ã€‚å»ºè®®æ‚¨åœ¨å……åˆ†å‡†å¤‡çš„åŸºç¡€ä¸Šï¼Œä¹Ÿè¦ç»™è‡ªå·±ä¸€äº›è¡ŒåŠ¨çš„æœºä¼šã€‚",
            "è´¢æ—º": f"ç›®å‰{age_range}å²çš„è¿åŠ¿ï¼Œ{influence}ã€‚è¿™æ˜¯è¿½æ±‚å…·ä½“æˆæœçš„æœ‰åˆ©æ—¶æœŸï¼Œè¦æŠ“ä½æ—¶æœºè¡ŒåŠ¨ã€‚",
            "ç…é‡": f"å½“å‰{age_range}å²ï¼Œ{influence}ã€‚è¿™ä¸ªé˜¶æ®µæ‚¨çš„æ‰¿å‹èƒ½åŠ›ä¼šå¾—åˆ°å¾ˆå¥½çš„å‘æŒ¥ï¼Œå¯ä»¥æ¥å—ä¸€äº›æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ã€‚",
            "ä¼¤å®˜æ—º": f"åœ¨{age_range}å²è¿™ä¸ªåˆ›é€ åŠ›æ—ºç››çš„æ—¶æœŸï¼Œ{influence}ã€‚å»ºè®®å¤šå°è¯•åˆ›æ–°å’Œè¡¨è¾¾ï¼Œä¸è¦å‹æŠ‘è‡ªå·±çš„æƒ³æ³•ã€‚"
        }
        
        return timing_templates.get(geju_type, f"å½“å‰{age_range}å²ï¼Œ{influence}ã€‚å»ºè®®é¡ºåº”è‡ªå·±çš„å†…åœ¨èŠ‚å¥ï¼Œè¯¥è¡ŒåŠ¨æ—¶è¡ŒåŠ¨ï¼Œè¯¥ç­‰å¾…æ—¶ç­‰å¾…ã€‚")
    
    def _generate_energy_management(self, bazi_analysis: Dict[str, Any]) -> str:
        """ç”Ÿæˆèƒ½é‡ç®¡ç†å»ºè®®"""
        hanzao_info = bazi_analysis.get("å®šå¯’ç‡¥", {})
        climate_type = hanzao_info.get("ç±»å‹", "å¹³å’Œ")
        need_element = hanzao_info.get("éœ€è¦è°ƒå€™", "")
        
        wuxing_stats = bazi_analysis.get("äº”è¡Œç»Ÿè®¡", {})
        strongest = wuxing_stats.get("æœ€æ—º", "")
        weakest = wuxing_stats.get("æœ€å¼±", "")
        
        energy_tips = []
        
        # åŸºäºè°ƒå€™éœ€æ±‚
        if "å¯’" in climate_type:
            energy_tips.append("æ‚¨çš„èƒ½é‡å®¹æ˜“å†…æ•›ï¼Œå»ºè®®å¤šæ¥è§¦é˜³å…‰å’Œæ­£èƒ½é‡çš„ç¯å¢ƒï¼Œé€‚å½“å¢åŠ ç¤¾äº¤æ´»åŠ¨ã€‚")
        elif "ç‡¥" in climate_type:
            energy_tips.append("æ‚¨çš„èƒ½é‡å®¹æ˜“è¿‡çƒ­ï¼Œå»ºè®®ä¿æŒå†…å¿ƒçš„å®é™ï¼Œå¤šåœ¨å®‰é™çš„ç¯å¢ƒä¸­æ€è€ƒå’Œä¼‘æ¯ã€‚")
        else:
            energy_tips.append("æ‚¨çš„èƒ½é‡ç›¸å¯¹å¹³è¡¡ï¼Œä¿æŒç°æœ‰çš„ç”Ÿæ´»èŠ‚å¥å³å¯ã€‚")
        
        # åŸºäºäº”è¡Œåˆ†å¸ƒ
        if strongest and weakest:
            energy_tips.append(f"æ‚¨çš„{strongest}èƒ½é‡å¾ˆå……æ²›ï¼Œå¯ä»¥å¤šå‘æŒ¥è¿™æ–¹é¢çš„ä¼˜åŠ¿ï¼›{weakest}ç›¸å¯¹è¾ƒå¼±ï¼Œéœ€è¦é€‚å½“è¡¥å……å’Œå¹³è¡¡ã€‚")
        
        # æ—¥å¸¸èƒ½é‡ç®¡ç†å»ºè®®
        daily_tips = [
            "æ¯å¤©ç•™å‡ºä¸€äº›å®‰é™çš„æ—¶é—´ä¸è‡ªå·±å¯¹è¯ï¼Œäº†è§£å†…åœ¨çš„å£°éŸ³ã€‚",
            "åœ¨åšé‡è¦å†³å®šä¹‹å‰ï¼Œé—®é—®è‡ªå·±ï¼šè¿™ä¸ªé€‰æ‹©æ˜¯å¦ç¬¦åˆæˆ‘çš„æ ¸å¿ƒä»·å€¼è§‚ï¼Ÿ",
            "å®šæœŸæ£€è§†è‡ªå·±çš„èƒ½é‡çŠ¶æ€ï¼Œè¯¥ä¼‘æ¯æ—¶ä¼‘æ¯ï¼Œè¯¥è¡ŒåŠ¨æ—¶è¡ŒåŠ¨ã€‚"
        ]
        
        energy_tips.extend(daily_tips[:2])
        
        return " ".join(energy_tips)
    
    def format_solution_output(self, solution: PersonalizedSolution) -> str:
        """æ ¼å¼åŒ–è§£å†³æ–¹æ¡ˆè¾“å‡º"""
        output_parts = []
        
        output_parts.append("### ğŸŒŸ æ‚¨çš„ä¼˜åŠ¿æ¨¡å¼")
        for pattern in solution.strength_patterns:
            output_parts.append(f"âœ¨ {pattern}")
        output_parts.append("")
        
        if solution.blind_spots:
            output_parts.append("### ğŸ’ æ¸©é¦¨æé†’")
            for spot in solution.blind_spots:
                output_parts.append(f"ğŸ’¡ {spot}")
            output_parts.append("")
        
        output_parts.append("### ğŸ“‹ å…·ä½“è¡ŒåŠ¨å»ºè®®")
        for step in solution.actionable_steps:
            output_parts.append(f"â–¶ï¸ {step}")
        output_parts.append("")
        
        if solution.medicine_guidance:
            output_parts.append("### ğŸ’Š æ„è¯†èƒ½é‡è°ƒèŠ‚")
            for medicine_type, guidance in solution.medicine_guidance.items():
                output_parts.append(f"ğŸ”¹ **{medicine_type}**: {guidance}")
            output_parts.append("")
        
        output_parts.append("### â° æ—¶æœºæŠŠæ¡")
        output_parts.append(f"ğŸ• {solution.timing_advice}")
        output_parts.append("")
        
        output_parts.append("### âš¡ èƒ½é‡ç®¡ç†")
        output_parts.append(f"ğŸ”‹ {solution.energy_management}")
        
        return "\n".join(output_parts)