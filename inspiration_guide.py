"""
å¯å‘å¼é—®é¢˜å¼•å¯¼æ¨¡å—
Inspiration Guide Module

åŠŸèƒ½ï¼š
1. é‡æ–°æ¡†å®šé—®é¢˜ï¼Œä»æ›´é«˜ç»´åº¦æ€è€ƒ
2. ç”Ÿæˆå¯å‘æ€§çš„åæ€é—®é¢˜
3. å¼•å¯¼ç”¨æˆ·æ¢ç´¢å†…åœ¨åŠ¨æœº
4. æä¾›å¤šè§’åº¦çš„æ€è€ƒè·¯å¾„
5. é¿å…ç»™å‡ºç¡®å®šæ€§ç­”æ¡ˆï¼Œè€Œæ˜¯å¯å‘æ€è€ƒ
"""

from typing import Dict, Any, List, Optional
from dataclasses import dataclass
from deep_question_analyzer import QuestionAnalysis

@dataclass 
class InspirationResult:
    """å¯å‘å¼•å¯¼ç»“æœ"""
    reframed_perspective: str    # é‡æ–°æ¡†å®šçš„è§†è§’
    deeper_questions: List[str]  # æ›´æ·±å±‚çš„åæ€é—®é¢˜
    multiple_angles: List[str]   # å¤šè§’åº¦æ€è€ƒ
    wisdom_insights: List[str]   # æ™ºæ…§æ´å¯Ÿ
    consciousness_elevation: str # æ„è¯†å±‚æ¬¡æå‡

class InspirationGuide:
    """å¯å‘å¼é—®é¢˜å¼•å¯¼å™¨"""
    
    def __init__(self):
        # é‡æ–°æ¡†å®šé—®é¢˜çš„æ¨¡æ¿
        self.reframe_templates = {
            "career_entrepreneurship": {
                "surface": "æˆ‘é€‚åˆåˆ›ä¸šå—ï¼Ÿ",
                "deeper": [
                    "æˆ‘ä¸ºä»€ä¹ˆä¼šè¢«åˆ›ä¸šè¿™ä¸ªæƒ³æ³•å¸å¼•ï¼Ÿ",
                    "æˆ‘æƒ³è¦é€šè¿‡åˆ›ä¸šè·å¾—ä»€ä¹ˆâ€”â€”æ˜¯é‡‘é’±ã€è‡ªç”±ã€è¿˜æ˜¯æˆå°±æ„Ÿï¼Ÿ",
                    "é™¤äº†åˆ›ä¸šï¼Œè¿˜æœ‰ä»€ä¹ˆå…¶ä»–æ–¹å¼èƒ½è®©æˆ‘è·å¾—å†…å¿ƒçœŸæ­£æ¸´æœ›çš„ä¸œè¥¿ï¼Ÿ",
                    "æˆ‘å‡†å¤‡ä¸ºäº†è¿™ä¸ªé€‰æ‹©ä»˜å‡ºä»€ä¹ˆä»£ä»·ï¼Ÿ"
                ]
            },
            "relationships_marriage": {
                "surface": "æˆ‘ä»¬åˆé€‚å—ï¼Ÿ",
                "deeper": [
                    "æˆ‘åœ¨è¿™æ®µå…³ç³»ä¸­èƒ½æˆä¸ºæœ€å¥½çš„è‡ªå·±å—ï¼Ÿ",
                    "æˆ‘å¯¹ä¼´ä¾£çš„æœŸå¾…ï¼Œæ˜¯å¦ä¹Ÿåæ˜ äº†æˆ‘å¯¹è‡ªå·±çš„æœŸå¾…ï¼Ÿ",
                    "è¿™æ®µå…³ç³»æ˜¯åœ¨å¸®åŠ©æˆ‘æˆé•¿ï¼Œè¿˜æ˜¯è®©æˆ‘åœæ»ï¼Ÿ",
                    "æˆ‘æ˜¯åœ¨å¯»æ‰¾ä¸€ä¸ªä¼´ä¾£ï¼Œè¿˜æ˜¯åœ¨å¯»æ‰¾å†…å¿ƒçš„å®Œæ•´ï¼Ÿ"
                ]
            },
            "health_wellbeing": {
                "surface": "æˆ‘çš„èº«ä½“æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ",
                "deeper": [
                    "æˆ‘çš„èº«ä½“çŠ¶å†µåæ˜ äº†ä»€ä¹ˆæ ·çš„ç”Ÿæ´»æ¨¡å¼ï¼Ÿ",
                    "æˆ‘æ˜¯åœ¨çœŸæ­£å…³çˆ±è‡ªå·±ï¼Œè¿˜æ˜¯åœ¨æ¶ˆè€—è‡ªå·±ï¼Ÿ",
                    "ä»€ä¹ˆæ ·çš„ç”Ÿæ´»èŠ‚å¥æœ€ç¬¦åˆæˆ‘çš„å†…åœ¨éœ€æ±‚ï¼Ÿ",
                    "æˆ‘å¦‚ä½•èƒ½è®©èº«ä½“æˆä¸ºæ”¯æŒæ¢¦æƒ³çš„ä¼™ä¼´ï¼Ÿ"
                ]
            },
            "personal_growth": {
                "surface": "æˆ‘éœ€è¦æ”¹å˜ä»€ä¹ˆï¼Ÿ",
                "deeper": [
                    "æˆ‘æƒ³è¦æ”¹å˜çš„ï¼Œæ˜¯çœŸçš„éœ€è¦æ”¹å˜ï¼Œè¿˜æ˜¯å› ä¸ºä¸å¤Ÿæ¥çº³è‡ªå·±ï¼Ÿ",
                    "æˆ‘çš„æˆé•¿åŠ¨åŠ›æ˜¯æ¥è‡ªå†…åœ¨çš„æ¸´æœ›ï¼Œè¿˜æ˜¯å¤–åœ¨çš„å‹åŠ›ï¼Ÿ",
                    "ä»€ä¹ˆæ ·çš„æˆé•¿æ–¹å‘æœ€ç¬¦åˆæˆ‘çš„å¤©æ€§ï¼Ÿ",
                    "æˆ‘å¦‚ä½•èƒ½åœ¨æˆé•¿çš„åŒæ—¶ä¿æŒå†…å¿ƒçš„å¹³é™ï¼Ÿ"
                ]
            },
            "life_direction": {
                "surface": "æˆ‘åº”è¯¥é€‰æ‹©å“ªæ¡è·¯ï¼Ÿ",
                "deeper": [
                    "å“ªæ¡è·¯èƒ½è®©æˆ‘åœ¨å›é¦–æ—¶æ„Ÿåˆ°æ— æ‚”ï¼Ÿ",
                    "æˆ‘å†…å¿ƒæœ€ä¸æ„¿æ„å¦¥åçš„æ˜¯ä»€ä¹ˆï¼Ÿ",
                    "å¦‚æœæ²¡æœ‰å¤–ç•Œçš„æœŸå¾…å’Œå‹åŠ›ï¼Œæˆ‘ä¼šé€‰æ‹©ä»€ä¹ˆï¼Ÿ",
                    "æˆ‘æƒ³è¦ç•™ä¸‹ä»€ä¹ˆæ ·çš„äººç”Ÿå°è®°ï¼Ÿ"
                ]
            }
        }
        
        # åŸºäºå‘½å±€çš„æ™ºæ…§æ´å¯Ÿæ¨¡æ¿
        self.wisdom_insights = {
            "æ¯”è‚©æ—º": [
                "çœŸæ­£çš„ç‹¬ç«‹ä¸æ˜¯æ‹’ç»ä¸€åˆ‡å¸®åŠ©ï¼Œè€Œæ˜¯çŸ¥é“ä»€ä¹ˆæ—¶å€™éœ€è¦ç‹¬è‡ªå‰è¡Œï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å›¢é˜Ÿåˆä½œã€‚",
                "æ‚¨çš„ä¼˜åŠ¿åœ¨äºåšæŒï¼Œä½†ä¹Ÿè¦è­¦æƒ•å›ºæ‰§ã€‚æœ€å¥½çš„å†³ç­–å¾€å¾€éœ€è¦æ—¢åšæŒåŸåˆ™ï¼Œåˆä¿æŒçµæ´»ã€‚",
                "æ‚¨å¤©ç”Ÿå°±æ˜¯é¢†å¯¼è€…çš„ææ–™ï¼Œä½†é¢†å¯¼åŠ›ä¸åœ¨äºæ§åˆ¶ä»–äººï¼Œè€Œåœ¨äºå½±å“å’Œæ¿€åŠ±ä»–äººã€‚"
            ],
            "å°é‡": [
                "å­¦ä¹ æ˜¯æ‚¨çš„å¤©èµ‹ï¼Œä½†ä¸è¦è®©å¯¹å®Œç¾çš„è¿½æ±‚é˜»æ­¢äº†è¡ŒåŠ¨çš„å¼€å§‹ã€‚",
                "å®‰å…¨æ„Ÿä¸æ¥è‡ªäºæ‹¥æœ‰æ‰€æœ‰çš„ç­”æ¡ˆï¼Œè€Œæ¥è‡ªäºç›¸ä¿¡è‡ªå·±æœ‰èƒ½åŠ›é¢å¯¹æœªçŸ¥ã€‚",
                "æ‚¨çš„æ™ºæ…§åœ¨äºæ·±åº¦æ€è€ƒï¼Œä½†æœ‰æ—¶å€™ç›´è§‰å’Œè¡ŒåŠ¨æ¯”åˆ†ææ›´é‡è¦ã€‚"
            ],
            "è´¢æ—º": [
                "æˆåŠŸä¸ä»…ä»…æ˜¯è¾¾åˆ°ç›®æ ‡ï¼Œæ›´é‡è¦çš„æ˜¯æˆä¸ºèƒ½å¤ŸæŒç»­è¾¾æˆç›®æ ‡çš„äººã€‚",
                "æ‚¨å–„äºæŠ“ä½æœºä¼šï¼Œä½†æœ€å¤§çš„æœºä¼šå¾€å¾€æ˜¯æˆä¸ºåˆ«äººæ„¿æ„ä¸ä¹‹åˆä½œçš„äººã€‚",
                "é‡‘é’±å’Œæˆå°±åªæ˜¯å‰¯äº§å“ï¼ŒçœŸæ­£çš„è´¢å¯Œæ˜¯æ‚¨èƒ½ä¸ºè¿™ä¸ªä¸–ç•Œåˆ›é€ çš„ä»·å€¼ã€‚"
            ],
            "ç…é‡": [
                "æ‚¨çš„åŠ›é‡åœ¨äºèƒ½å¤Ÿæ‰¿æ‹…è´£ä»»ï¼Œä½†ä¸è¦å¿˜è®°ï¼Œæœ€å¤§çš„è´£ä»»æ˜¯å¯¹è‡ªå·±çš„äººç”Ÿè´Ÿè´£ã€‚",
                "è§„åˆ™æ˜¯ä¸ºäº†ä¿æŠ¤å¤§å®¶ï¼Œä½†æ‚¨ä¹Ÿæœ‰åˆ›é€ æ–°è§„åˆ™çš„èƒ½åŠ›ã€‚",
                "æ‚¨åœ¨å‹åŠ›ä¸‹èƒ½å‘æŒ¥æœ€ä½³çŠ¶æ€ï¼Œè¿™æ˜¯å¤©èµ‹ï¼Œä½†ä¹Ÿè¦å­¦ä¼šåœ¨æ²¡æœ‰å‹åŠ›æ—¶ä¿æŒåŠ¨åŠ›ã€‚"
            ],
            "ä¼¤å®˜æ—º": [
                "æ‚¨çš„åˆ›é€ åŠ›æ˜¯ç¤¼ç‰©ï¼Œä½†è¦è®°ä½ï¼Œæœ€å¥½çš„åˆ›é€ æ˜¯æ—¢è¡¨è¾¾äº†è‡ªå·±åˆèƒ½å¤Ÿæ„ŸåŠ¨ä»–äººçš„ã€‚",
                "åå›æœ‰æ—¶æ˜¯å¿…è¦çš„ï¼Œä½†åå›çš„ç›®çš„åº”è¯¥æ˜¯å»ºè®¾ï¼Œè€Œä¸æ˜¯ç ´åã€‚",
                "æ‚¨ä¸éœ€è¦å¾—åˆ°æ‰€æœ‰äººçš„ç†è§£ï¼Œä½†è¦ç¡®ä¿ç†è§£æ‚¨çš„äººæ˜¯çœŸæ­£é‡è¦çš„äººã€‚"
            ]
        }
    
    def generate_inspiration(self, question_analysis: QuestionAnalysis, bazi_analysis: Dict[str, Any]) -> InspirationResult:
        """ç”Ÿæˆå®Œæ•´çš„å¯å‘å¼•å¯¼"""
        
        category = question_analysis.question_category
        original_q = question_analysis.original_question
        
        # 1. é‡æ–°æ¡†å®šè§†è§’
        reframed_perspective = self._generate_reframed_perspective(question_analysis, bazi_analysis)
        
        # 2. ç”Ÿæˆæ›´æ·±å±‚çš„é—®é¢˜
        deeper_questions = self._generate_deeper_questions(category, bazi_analysis)
        
        # 3. æä¾›å¤šè§’åº¦æ€è€ƒ
        multiple_angles = self._generate_multiple_angles(question_analysis, bazi_analysis)
        
        # 4. æ™ºæ…§æ´å¯Ÿ
        wisdom_insights = self._generate_wisdom_insights(bazi_analysis)
        
        # 5. æ„è¯†å±‚æ¬¡æå‡
        consciousness_elevation = self._generate_consciousness_elevation(question_analysis, bazi_analysis)
        
        return InspirationResult(
            reframed_perspective=reframed_perspective,
            deeper_questions=deeper_questions,
            multiple_angles=multiple_angles,
            wisdom_insights=wisdom_insights,
            consciousness_elevation=consciousness_elevation
        )
    
    def _generate_reframed_perspective(self, question_analysis: QuestionAnalysis, bazi_analysis: Dict[str, Any]) -> str:
        """é‡æ–°æ¡†å®šé—®é¢˜è§†è§’"""
        category = question_analysis.question_category
        original = question_analysis.original_question
        
        geju_info = bazi_analysis.get("å®šæ ¼å±€", {})
        geju_type = geju_info.get("æ ¼å±€ç±»å‹", "")
        
        reframe_logic = {
            "career_entrepreneurship": {
                "æ¯”åŠ«æ—ºæ ¼": f"æ‚¨é—®'{original}'ï¼Œä½†æ›´é‡è¦çš„é—®é¢˜å¯èƒ½æ˜¯ï¼šæˆ‘å¦‚ä½•èƒ½å»ºç«‹ä¸€ä¸ªæ—¢èƒ½å‘æŒ¥æˆ‘ç‹¬ç«‹ç‰¹è´¨ï¼Œåˆèƒ½ä¸ä»–äººåä½œå…±èµ¢çš„äº‹ä¸šæ¨¡å¼ï¼Ÿ",
                "å°é‡æ ¼": f"æ¯”èµ·'{original}'ï¼Œæ‚¨æ›´éœ€è¦æ€è€ƒï¼šæˆ‘å¦‚ä½•èƒ½åœ¨ä¿æŒå­¦ä¹ æˆé•¿çš„åŒæ—¶ï¼Œä¹Ÿæ•¢äºæŠŠçŸ¥è¯†è½¬åŒ–ä¸ºå®é™…è¡ŒåŠ¨ï¼Ÿ",
                "è´¢æ—ºæ ¼": f"ä¸å…¶çº ç»“'{original}'ï¼Œä¸å¦‚æ¢ç´¢ï¼šæˆ‘å¦‚ä½•èƒ½åˆ›é€ ä¸€ç§æ—¢æœ‰ç¨³å®šæ”¶ç›Šï¼Œåˆèƒ½æŒç»­å¢é•¿çš„ä»·å€¼æ¨¡å¼ï¼Ÿ"
            },
            "relationships_marriage": {
                "æ¯”åŠ«æ—ºæ ¼": f"æ‚¨å…³å¿ƒ'{original}'ï¼Œä½†æ ¸å¿ƒé—®é¢˜å¯èƒ½æ˜¯ï¼šæˆ‘å¦‚ä½•èƒ½åœ¨ä¿æŒç‹¬ç«‹è‡ªæˆ‘çš„åŒæ—¶ï¼Œä¹Ÿç»™å¯¹æ–¹è¶³å¤Ÿçš„ç©ºé—´å’Œå°Šé‡ï¼Ÿ",
                "å°é‡æ ¼": f"æ¯”èµ·'{original}'ï¼Œæ‚¨æ›´éœ€è¦æ€è€ƒï¼šæˆ‘æ˜¯åœ¨å¯»æ‰¾ä¸€ä¸ªä¼´ä¾£ï¼Œè¿˜æ˜¯åœ¨å¯»æ‰¾ä¸€ä¸ªèƒ½è®©æˆ‘æ„Ÿåˆ°å®‰å…¨çš„ä¾é ï¼Ÿ"
            }
        }
        
        category_templates = reframe_logic.get(category, {})
        specific_template = category_templates.get(geju_type)
        
        if specific_template:
            return specific_template
        
        # é€šç”¨é‡æ–°æ¡†å®š
        return f"æ‚¨é—®'{original}'ï¼Œä½†æ›´æ·±å±‚çš„é—®é¢˜å¯èƒ½æ˜¯ï¼šæˆ‘å¦‚ä½•èƒ½åšå‡ºæ—¢ç¬¦åˆå†…å¿ƒçœŸå®å£°éŸ³ï¼Œåˆèƒ½å¸¦æ¥é•¿è¿œå¹¸ç¦çš„é€‰æ‹©ï¼Ÿ"
    
    def _generate_deeper_questions(self, category: str, bazi_analysis: Dict[str, Any]) -> List[str]:
        """ç”Ÿæˆæ›´æ·±å±‚çš„åæ€é—®é¢˜"""
        base_questions = self.reframe_templates.get(category, {}).get("deeper", [])
        
        # åŸºäºå‘½å±€ç‰¹å¾ä¸ªæ€§åŒ–é—®é¢˜
        geju_info = bazi_analysis.get("å®šæ ¼å±€", {})
        
        personalized_questions = []
        
        if "æ¯”åŠ«" in str(geju_info):
            personalized_questions.extend([
                "æ‚¨æ˜¯å¦å·²ç»å‡†å¤‡å¥½ç‹¬è‡ªæ‰¿æ‹…æ‰€æœ‰çš„è´£ä»»ï¼Ÿ",
                "æ‚¨çš„ç‹¬ç«‹æ˜¯ä¸ºäº†è¯æ˜ä»€ä¹ˆï¼Œè¿˜æ˜¯ä¸ºäº†è·å¾—ä»€ä¹ˆï¼Ÿ"
            ])
        elif "å°" in str(geju_info):
            personalized_questions.extend([
                "æ‚¨æ˜¯åœ¨å¯»æ±‚ä»–äººçš„è®¤å¯ï¼Œè¿˜æ˜¯çœŸå¿ƒç›¸ä¿¡è¿™ä¸ªæ–¹å‘ï¼Ÿ",
                "æ‚¨éœ€è¦å¤šå°‘å‡†å¤‡æ‰ä¼šè§‰å¾—è¶³å¤Ÿï¼Ÿ"
            ])
        elif "ä¼¤" in str(geju_info):
            personalized_questions.extend([
                "æ‚¨æƒ³è¦è¡¨è¾¾çš„çœŸæ­£å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ",
                "æ‚¨æ˜¯åœ¨åˆ›é€ æ–°çš„å¯èƒ½ï¼Œè¿˜æ˜¯åœ¨åå¯¹ç°æœ‰çš„è§„åˆ™ï¼Ÿ"
            ])
        
        # åˆå¹¶åŸºç¡€é—®é¢˜å’Œä¸ªæ€§åŒ–é—®é¢˜
        all_questions = base_questions + personalized_questions
        return all_questions[:4]  # é™åˆ¶åœ¨4ä¸ªé—®é¢˜
    
    def _generate_multiple_angles(self, question_analysis: QuestionAnalysis, bazi_analysis: Dict[str, Any]) -> List[str]:
        """æä¾›å¤šè§’åº¦æ€è€ƒ"""
        category = question_analysis.question_category
        
        angle_templates = {
            "career_entrepreneurship": [
                "ä»èƒ½åŠ›è§’åº¦ï¼šæ‚¨å…·å¤‡ä»€ä¹ˆç‹¬ç‰¹çš„ä¼˜åŠ¿å’Œèµ„æºï¼Ÿ",
                "ä»æ—¶æœºè§’åº¦ï¼šç°åœ¨æ˜¯ä¸æ˜¯æœ€é€‚åˆæ‚¨çš„æ—¶é—´ç‚¹ï¼Ÿ",
                "ä»å†…å¿ƒè§’åº¦ï¼šè¿™ä¸ªé€‰æ‹©æ˜¯å¦ä¸æ‚¨çš„æ ¸å¿ƒä»·å€¼è§‚ä¸€è‡´ï¼Ÿ",
                "ä»ç°å®è§’åº¦ï¼šæ‚¨èƒ½æ‰¿å—å¯èƒ½çš„å¤±è´¥å’Œä¸ç¡®å®šæ€§å—ï¼Ÿ"
            ],
            "relationships_marriage": [
                "ä»æˆé•¿è§’åº¦ï¼šè¿™æ®µå…³ç³»æ˜¯å¦åœ¨å¸®åŠ©æ‚¨æˆä¸ºæ›´å¥½çš„äººï¼Ÿ",
                "ä»ä»·å€¼è§‚è§’åº¦ï¼šæ‚¨ä»¬åœ¨é‡è¦çš„äººç”Ÿè®®é¢˜ä¸Šæ˜¯å¦ä¸€è‡´ï¼Ÿ",
                "ä»æƒ…æ„Ÿè§’åº¦ï¼šæ‚¨æ˜¯è¢«éœ€è¦æ„Ÿå¸å¼•ï¼Œè¿˜æ˜¯è¢«çˆ±æƒ…æœ¬èº«å¸å¼•ï¼Ÿ",
                "ä»é•¿è¿œè§’åº¦ï¼šæ‚¨èƒ½æƒ³è±¡å’Œè¿™ä¸ªäººä¸€èµ·åº¦è¿‡äººç”Ÿçš„å„ä¸ªé˜¶æ®µå—ï¼Ÿ"
            ],
            "health_wellbeing": [
                "ä»ç”Ÿæ´»æ–¹å¼è§’åº¦ï¼šæ‚¨çš„æ—¥å¸¸ä¹ æƒ¯æ˜¯åœ¨æ”¯æŒå¥åº·è¿˜æ˜¯åœ¨é€æ”¯èº«ä½“ï¼Ÿ",
                "ä»å¿ƒç†è§’åº¦ï¼šæ‚¨å¯¹èº«ä½“çš„å…³æ³¨æ˜¯æ¥è‡ªçˆ±æŠ¤è¿˜æ˜¯æ¥è‡ªææƒ§ï¼Ÿ",
                "ä»èƒ½é‡è§’åº¦ï¼šä»€ä¹ˆæ ·çš„æ´»åŠ¨èƒ½è®©æ‚¨æ„Ÿåˆ°çœŸæ­£çš„æ´»åŠ›ï¼Ÿ",
                "ä»å¹³è¡¡è§’åº¦ï¼šæ‚¨å¦‚ä½•åœ¨å·¥ä½œå’Œä¼‘æ¯ä¹‹é—´æ‰¾åˆ°æœ€ä½³çš„èŠ‚å¥ï¼Ÿ"
            ]
        }
        
        return angle_templates.get(category, [
            "ä»å†…å¿ƒè§’åº¦ï¼šè¿™ä¸ªé€‰æ‹©çœŸçš„ç¬¦åˆæ‚¨çš„ä»·å€¼è§‚å—ï¼Ÿ",
            "ä»é•¿è¿œè§’åº¦ï¼šè¿™ä¸ªå†³å®šä¼šè®©æ‚¨æˆä¸ºä»€ä¹ˆæ ·çš„äººï¼Ÿ",
            "ä»ç°å®è§’åº¦ï¼šæ‚¨å‡†å¤‡ä¸ºè¿™ä¸ªé€‰æ‹©ä»˜å‡ºä»€ä¹ˆï¼Ÿ",
            "ä»æˆé•¿è§’åº¦ï¼šè¿™ä¸ªç»å†ä¼šå¸¦ç»™æ‚¨ä»€ä¹ˆæ ·çš„å­¦ä¹ ï¼Ÿ"
        ])
    
    def _generate_wisdom_insights(self, bazi_analysis: Dict[str, Any]) -> List[str]:
        """ç”Ÿæˆæ™ºæ…§æ´å¯Ÿ"""
        geju_info = bazi_analysis.get("å®šæ ¼å±€", {})
        geju_type = geju_info.get("æ ¼å±€ç±»å‹", "")
        
        insights = self.wisdom_insights.get(geju_type, [
            "æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±ç‹¬ç‰¹çš„èŠ‚å¥ï¼Œä¸è¦æ€¥äºæ¨¡ä»¿ä»–äººçš„æ­¥ä¼ã€‚",
            "æœ€å¥½çš„å†³å®šå¾€å¾€ä¸æ˜¯æœ€å®Œç¾çš„ï¼Œè€Œæ˜¯æœ€é€‚åˆå½“ä¸‹çš„æ‚¨çš„ã€‚",
            "ä¿¡ä»»è‡ªå·±çš„ç›´è§‰ï¼Œä½†ä¹Ÿè¦ç”¨ç†æ€§éªŒè¯ç›´è§‰çš„æ­£ç¡®æ€§ã€‚"
        ])
        
        return insights[:2]  # é™åˆ¶åœ¨2æ¡ä»¥å†…
    
    def _generate_consciousness_elevation(self, question_analysis: QuestionAnalysis, bazi_analysis: Dict[str, Any]) -> str:
        """ç”Ÿæˆæ„è¯†å±‚æ¬¡æå‡çš„å¼•å¯¼"""
        category = question_analysis.question_category
        emotional_tone = question_analysis.emotional_undertone
        
        elevation_templates = {
            "anxiety": "å½“æˆ‘ä»¬èƒ½å¤Ÿä»æ›´é«˜çš„ç»´åº¦çœ‹å¾…è¿™ä¸ªé—®é¢˜æ—¶ï¼Œç„¦è™‘å¾€å¾€ä¼šè½¬åŒ–ä¸ºæ¸…æ™°çš„æ´å¯Ÿã€‚æ‚¨ç°åœ¨æ‹…å¿ƒçš„äº‹æƒ…ï¼Œå…¶å®æ­£æ˜¯æ‚¨å†…åœ¨æ™ºæ…§æƒ³è¦çªç ´çš„åœ°æ–¹ã€‚",
            "confusion": "è¿·èŒ«ä¸æ˜¯åäº‹ï¼Œå®ƒè¯´æ˜æ‚¨æ­£åœ¨æˆé•¿çš„è¾¹ç•Œä¸Šã€‚çœŸæ­£çš„æ¸…æ™°ä¸æ˜¯æ¶ˆé™¤æ‰€æœ‰çš„ä¸ç¡®å®šæ€§ï¼Œè€Œæ˜¯åœ¨ä¸ç¡®å®šä¸­æ‰¾åˆ°å†…åœ¨çš„ç¬ƒå®šã€‚",
            "aspiration": "æ‚¨çš„æ¸´æœ›æ˜¯å†…åœ¨æ™ºæ…§çš„å£°éŸ³ã€‚ä½†è¦è®°ä½ï¼Œæœ€æŒä¹…çš„æ»¡è¶³å¾€å¾€æ¥è‡ªäºè¿‡ç¨‹ä¸­çš„æˆé•¿ï¼Œè€Œä¸ä»…ä»…æ˜¯ç»“æœçš„è·å¾—ã€‚",
            "doubt": "æ€€ç–‘ä¹Ÿæ˜¯ä¸€ç§æ™ºæ…§ã€‚å®ƒæé†’æ‚¨ä¸è¦ç›²ç›®è·Ÿä»ï¼Œè€Œè¦æ‰¾åˆ°çœŸæ­£å±äºè‡ªå·±çš„ç­”æ¡ˆã€‚ç›¸ä¿¡æ‚¨çš„å†…å¿ƒï¼Œå®ƒæ¯”æ‚¨æƒ³è±¡çš„æ›´åŠ èªæ˜ã€‚"
        }
        
        base_elevation = elevation_templates.get(emotional_tone, 
            "æ¯ä¸€ä¸ªé—®é¢˜çš„èƒŒåï¼Œéƒ½æ˜¯æ‚¨å†…åœ¨æ™ºæ…§æƒ³è¦ä¸æ‚¨å¯¹è¯çš„æœºä¼šã€‚é™ä¸‹å¿ƒæ¥å€¾å¬ï¼Œç­”æ¡ˆå¾€å¾€æ¯”æ‚¨æƒ³è±¡çš„æ›´æ¸…æ™°ã€‚"
        )
        
        # åŸºäºå‘½å±€ç‰¹å¾æ·»åŠ ä¸ªæ€§åŒ–æå‡
        geju_info = bazi_analysis.get("å®šæ ¼å±€", {})
        if "æ¯”åŠ«" in str(geju_info):
            personal_note = "æ‚¨å¤©ç”Ÿå°±æœ‰ç‹¬ç«‹æ€è€ƒçš„èƒ½åŠ›ï¼Œç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­ï¼Œä½†ä¹Ÿè¦ä¿æŒå¼€æ”¾çš„å¿ƒæ€ã€‚"
        elif "å°" in str(geju_info):
            personal_note = "æ‚¨çš„æ™ºæ…§åœ¨äºæ·±åº¦æ€è€ƒï¼Œä½†æœ‰æ—¶å€™è¡ŒåŠ¨æœ¬èº«å°±æ˜¯æœ€å¥½çš„å­¦ä¹ ã€‚"
        elif "ä¼¤" in str(geju_info):
            personal_note = "æ‚¨çš„åˆ›é€ åŠ›æ˜¯å¤©èµ‹ï¼Œç”¨å®ƒæ¥åˆ›é€ ç¾å¥½ï¼Œè€Œä¸ä»…ä»…æ˜¯è¡¨è¾¾ä¸æ»¡ã€‚"
        else:
            personal_note = "æ‚¨æœ‰ç€ç‹¬ç‰¹çš„èƒ½é‡ç»„åˆï¼Œè¿™å°±æ˜¯æ‚¨æœ€å¤§çš„ä¼˜åŠ¿ã€‚"
        
        return f"{base_elevation} {personal_note}"
    
    def generate_breakthrough_insights(self, question_analysis: QuestionAnalysis, bazi_analysis: Dict[str, Any]) -> str:
        """ç”Ÿæˆçªç ´æ€§æ´å¯Ÿ"""
        category = question_analysis.question_category
        core_issue = question_analysis.core_issue
        
        # åŸºäºä¸åŒç±»å‹çš„é—®é¢˜ç”Ÿæˆçªç ´æ€§æ€è·¯
        breakthrough_templates = {
            "career_entrepreneurship": """
            çœŸæ­£çš„çªç ´ä¸åœ¨äºé€‰æ‹©åˆ›ä¸šè¿˜æ˜¯æ‰“å·¥ï¼Œè€Œåœ¨äºç†è§£ï¼šæˆåŠŸçš„å®šä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ
            
            å¦‚æœæ‚¨çš„å†…å¿ƒæ¸´æœ›ç‹¬ç«‹å’ŒæŒæ§ï¼Œé‚£ä¹ˆå³ä½¿åœ¨æ‰“å·¥çš„ç¯å¢ƒä¸­ï¼Œæ‚¨ä¹Ÿå¯ä»¥å¯»æ‰¾æ›´å¤šçš„è‡ªä¸»æƒå’Œå†³ç­–ç©ºé—´ã€‚
            å¦‚æœæ‚¨çš„ç›®æ ‡æ˜¯è´¢åŠ¡è‡ªç”±ï¼Œé‚£ä¹ˆåˆ›ä¸šåªæ˜¯å…¶ä¸­ä¸€æ¡è·¯å¾„ï¼ŒæŠ•èµ„ã€å‰¯ä¸šã€æŠ€èƒ½å˜ç°éƒ½å¯èƒ½æ˜¯æ›´é€‚åˆçš„é€‰æ‹©ã€‚
            å¦‚æœæ‚¨æƒ³è¦è¯æ˜è‡ªå·±çš„ä»·å€¼ï¼Œé‚£ä¹ˆæœ€é‡è¦çš„æ˜¯å…ˆåœ¨å†…å¿ƒç¡®è®¤è‡ªå·±çš„ä»·å€¼ï¼Œè€Œä¸æ˜¯é€šè¿‡å¤–åœ¨çš„æˆåŠŸæ¥è¯æ˜ã€‚
            
            å…³é”®çš„çªç ´åœ¨äºï¼šæ‚¨èƒ½å¦æ‰¾åˆ°ä¸€ç§æ—¢å‘æŒ¥ä¼˜åŠ¿åˆäº«å—è¿‡ç¨‹çš„å·¥ä½œæ–¹å¼ï¼Ÿ
            """,
            
            "relationships_marriage": """
            çœŸæ­£çš„çªç ´ä¸åœ¨äºé€‰æ‹©è¿™ä¸ªäººè¿˜æ˜¯é‚£ä¸ªäººï¼Œè€Œåœ¨äºç†è§£ï¼šæˆ‘æƒ³è¦åœ¨å…³ç³»ä¸­æˆä¸ºä»€ä¹ˆæ ·çš„äººï¼Ÿ
            
            å¦‚æœæ‚¨æ€»æ˜¯åœ¨å…³ç³»ä¸­æ„Ÿåˆ°ä¸æ»¡ï¼Œå¯èƒ½ä¸æ˜¯å¯¹æ–¹çš„é—®é¢˜ï¼Œè€Œæ˜¯æ‚¨è¿˜æ²¡æœ‰å­¦ä¼šçˆ±è‡ªå·±ã€‚
            å¦‚æœæ‚¨æ€»æ˜¯æ‹…å¿ƒå¯¹æ–¹ä¼šç¦»å¼€ï¼Œå¯èƒ½éœ€è¦å…ˆå»ºç«‹èµ·å¯¹è‡ªå·±çš„ä¿¡å¿ƒå’Œå®‰å…¨æ„Ÿã€‚
            å¦‚æœæ‚¨æ€»æ˜¯æƒ³è¦æ”¹å˜å¯¹æ–¹ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ‚¨è¿˜æ²¡æœ‰å®Œå…¨æ¥çº³ç°åœ¨çš„è‡ªå·±ã€‚
            
            å…³é”®çš„çªç ´åœ¨äºï¼šæ‚¨èƒ½å¦åœ¨å…³ç³»ä¸­æ—¢ä¿æŒçœŸå®çš„è‡ªå·±ï¼Œåˆç»™äºˆå¯¹æ–¹æˆé•¿çš„ç©ºé—´ï¼Ÿ
            """,
            
            "health_wellbeing": """
            çœŸæ­£çš„çªç ´ä¸åœ¨äºæ‰¾åˆ°å®Œç¾çš„å¥åº·æ–¹æ¡ˆï¼Œè€Œåœ¨äºç†è§£ï¼šä»€ä¹ˆæ ·çš„ç”Ÿæ´»æ–¹å¼æœ€ç¬¦åˆæˆ‘çš„æœ¬æ€§ï¼Ÿ
            
            å¦‚æœæ‚¨æ€»æ˜¯æ„Ÿåˆ°ç–²æƒ«ï¼Œå¯èƒ½ä¸æ˜¯èº«ä½“çš„é—®é¢˜ï¼Œè€Œæ˜¯ç”Ÿæ´»æ–¹å¼ä¸å†…åœ¨èŠ‚å¥ä¸åŒ¹é…ã€‚
            å¦‚æœæ‚¨æ€»æ˜¯æ‹…å¿ƒå¥åº·ï¼Œå¯èƒ½éœ€è¦å…ˆå»ºç«‹èµ·å¯¹ç”Ÿå‘½åŠ›çš„ä¿¡ä»»ã€‚
            å¦‚æœæ‚¨æ€»æ˜¯æ— æ³•åšæŒå¥åº·ä¹ æƒ¯ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¿™äº›ä¹ æƒ¯ä¸å¤Ÿç¬¦åˆæ‚¨çš„å¤©æ€§ã€‚
            
            å…³é”®çš„çªç ´åœ¨äºï¼šæ‚¨èƒ½å¦æ‰¾åˆ°ä¸€ç§æ—¢ä¿æŒæ´»åŠ›åˆå¯æŒç»­çš„ç”Ÿæ´»èŠ‚å¥ï¼Ÿ
            """
        }
        
        return breakthrough_templates.get(category, """
        çœŸæ­£çš„çªç ´å¾€å¾€ä¸åœ¨äºæ‰¾åˆ°æ ‡å‡†ç­”æ¡ˆï¼Œè€Œåœ¨äºå­¦ä¼šæå‡ºæ›´å¥½çš„é—®é¢˜ã€‚
        
        å½“æˆ‘ä»¬èƒ½å¤Ÿä»'æˆ‘åº”è¯¥æ€ä¹ˆé€‰æ‹©'è½¬å‘'æˆ‘æƒ³è¦æˆä¸ºä»€ä¹ˆæ ·çš„äºº'æ—¶ï¼Œ
        å½“æˆ‘ä»¬èƒ½å¤Ÿä»'è¿™æ ·åšå¯¹ä¸å¯¹'è½¬å‘'è¿™æ ·åšæ˜¯å¦ç¬¦åˆæˆ‘çš„ä»·å€¼è§‚'æ—¶ï¼Œ
        å½“æˆ‘ä»¬èƒ½å¤Ÿä»'åˆ«äººä¼šæ€ä¹ˆçœ‹'è½¬å‘'æˆ‘çœŸæ­£å…³å¿ƒä»€ä¹ˆ'æ—¶ï¼Œ
        
        ç­”æ¡ˆå¾€å¾€å°±è‡ªç„¶è€Œç„¶åœ°æµ®ç°äº†ã€‚
        """).strip()
    
    def format_inspiration_output(self, inspiration: InspirationResult) -> str:
        """æ ¼å¼åŒ–å¯å‘è¾“å‡º"""
        output_parts = []
        
        output_parts.append("### ğŸ”„ æ¢ä¸ªè§’åº¦çœ‹é—®é¢˜")
        output_parts.append(inspiration.reframed_perspective)
        output_parts.append("")
        
        output_parts.append("### ğŸ¤” å€¼å¾—æ·±æ€çš„é—®é¢˜")
        for i, question in enumerate(inspiration.deeper_questions, 1):
            output_parts.append(f"{i}. {question}")
        output_parts.append("")
        
        output_parts.append("### ğŸŒŸ å¤šç»´åº¦æ€è€ƒ")
        for angle in inspiration.multiple_angles:
            output_parts.append(f"â€¢ {angle}")
        output_parts.append("")
        
        output_parts.append("### ğŸ’¡ æ™ºæ…§æ´å¯Ÿ")
        for insight in inspiration.wisdom_insights:
            output_parts.append(f"ğŸ’­ {insight}")
        output_parts.append("")
        
        output_parts.append("### â¬†ï¸ æ„è¯†å±‚æ¬¡çš„æå‡")
        output_parts.append(inspiration.consciousness_elevation)
        
        return "\n".join(output_parts)